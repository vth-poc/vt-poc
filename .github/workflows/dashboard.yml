name: Fetch Issues and Deploy Dashboard

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
  
  # Trigger on issue events (opened, edited, closed, assigned, labeled, etc.)
  issues:
    types: [opened, edited, deleted, closed, reopened, assigned, unassigned, labeled, unlabeled]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read      # ‚úÖ Checkout repository
  pages: write        # ‚úÖ Deploy to GitHub Pages
  id-token: write     # ‚úÖ OIDC token for secure deployment validation
  issues: read        # ‚úÖ Fetch issues via GitHub API

# Allow only one concurrent deployment, cancel in-progress runs in favor of latest
concurrency:
  group: "pages-deployment"
  cancel-in-progress: true

jobs:
  # Fetch issues and deploy
  fetch-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create data directory
        run: mkdir -p docs/data
      
      - name: Fetch all issues from GitHub API
        id: fetch-issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching issues from ${{ github.repository }}..."

          # Extract 'since' date from config.toml
          SINCE_DATE=$(grep -A 3 '\[issues-api\]' docs/config.toml | grep 'since' | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$SINCE_DATE" ]; then
            echo "‚ùå 'since' date not found in config.toml. Please ensure it is set under [issues-api]."
            exit 1
          fi
          echo "üìÖ Using since date: $SINCE_DATE"

          PAGE=1
          TEMP_ALL_ISSUES_FILE="temp_all_issues.json"
          TEMP_MERGED_ISSUES_FILE="temp_merged_issues.json"
          OUTPUT_FILE="docs/data/issues.json"

          # Initialize empty array
          echo "[]" > "$TEMP_ALL_ISSUES_FILE"

          # Fetch issues with 'project' label
          echo "ÔøΩ Fetching 'project' issues..."
          PAGE=1
          while true; do
            echo "üìÑ Processing 'project' page $PAGE..."
            
            if ! RESPONSE=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues?state=all&labels=project&per_page=100&page=$PAGE&sort=updated&direction=desc&since=$SINCE_DATE" 2>/dev/null); then
              echo "‚ùå Failed to fetch 'project' page $PAGE"
              break
            fi
            
            if [ -z "$RESPONSE" ] || [ "$RESPONSE" = '[]' ]; then
              echo "‚úÖ No more 'project' issues to fetch."
              break
            fi
            
            jq -s '.[0] + .[1]' "$TEMP_ALL_ISSUES_FILE" <(echo "$RESPONSE") > "$TEMP_MERGED_ISSUES_FILE"
            mv "$TEMP_MERGED_ISSUES_FILE" "$TEMP_ALL_ISSUES_FILE"

            COUNT=$(echo "$RESPONSE" | jq length)
            if [ $COUNT -lt 100 ]; then
              echo "‚úÖ Reached final 'project' page."
              break
            fi
            
            ((PAGE++))
            sleep 1
          done

          # Fetch issues with 'enhancement' label
          echo "üìã Fetching 'enhancement' issues..."
          PAGE=1
          while true; do
            echo "üìÑ Processing 'enhancement' page $PAGE..."
            
            if ! RESPONSE=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues?state=all&labels=enhancement&per_page=100&page=$PAGE&sort=updated&direction=desc&since=$SINCE_DATE" 2>/dev/null); then
              echo "‚ùå Failed to fetch 'enhancement' page $PAGE"
              break
            fi
            
            if [ -z "$RESPONSE" ] || [ "$RESPONSE" = '[]' ]; then
              echo "‚úÖ No more 'enhancement' issues to fetch."
              break
            fi
            
            jq -s '.[0] + .[1]' "$TEMP_ALL_ISSUES_FILE" <(echo "$RESPONSE") > "$TEMP_MERGED_ISSUES_FILE"
            mv "$TEMP_MERGED_ISSUES_FILE" "$TEMP_ALL_ISSUES_FILE"

            COUNT=$(echo "$RESPONSE" | jq length)
            if [ $COUNT -lt 100 ]; then
              echo "‚úÖ Reached final 'enhancement' page."
              break
            fi
            
            ((PAGE++))
            sleep 1
          done

          # Remove duplicates (issues with both labels) and save
          jq 'unique_by(.id) | sort_by(.number)' "$TEMP_ALL_ISSUES_FILE" > "$OUTPUT_FILE"

          # Cleanup
          rm -rf "$TEMP_ALL_ISSUES_FILE" "$TEMP_MERGED_ISSUES_FILE"

          # Show summary
          TOTAL_ISSUES=$(jq length "$OUTPUT_FILE")
          OPEN_ISSUES=$(jq '[.[] | select(.state == "open")] | length' "$OUTPUT_FILE")
          CLOSED_ISSUES=$(jq '[.[] | select(.state == "closed")] | length' "$OUTPUT_FILE")
          BLOCKED_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "blocked")] | length' "$OUTPUT_FILE")
          WIN_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "win")] | length' "$OUTPUT_FILE")
          
          echo "üéâ Successfully saved $TOTAL_ISSUES issues to $OUTPUT_FILE"
          echo "üìä Open: $OPEN_ISSUES | Closed: $CLOSED_ISSUES"
          echo "ÔøΩ Blocked: $BLOCKED_ISSUES | üèÜ Wins: $WIN_ISSUES"
          echo "ÔøΩüìÖ Filtered since: $SINCE_DATE"
          
          # Set outputs for summary
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_issues=$CLOSED_ISSUES" >> $GITHUB_OUTPUT
          echo "blocked_issues=$BLOCKED_ISSUES" >> $GITHUB_OUTPUT
          echo "win_issues=$WIN_ISSUES" >> $GITHUB_OUTPUT
          echo "since_date=$SINCE_DATE" >> $GITHUB_OUTPUT
      
      - name: Generate Workflow Summary
        run: |
          echo "## üìä Dashboard Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues Fetched" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Issues:** ${{ steps.fetch-issues.outputs.total_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Open Issues:** ${{ steps.fetch-issues.outputs.open_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Closed Issues:** ${{ steps.fetch-issues.outputs.closed_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üö´ Blocked Issues:** ${{ steps.fetch-issues.outputs.blocked_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üèÜ Win Issues:** ${{ steps.fetch-issues.outputs.win_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Since Date:** ${{ steps.fetch-issues.outputs.since_date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Label Filters" >> $GITHUB_STEP_SUMMARY
          echo "Only issues with \`project\` or \`enhancement\` labels are included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Dashboard successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload docs directory (includes data folder with issues.json)
          path: './docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
