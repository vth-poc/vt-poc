name: Fetch Issues and Deploy Dashboard

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]
  
  # Trigger on issue events (opened, edited, closed, assigned, labeled, etc.)
  issues:
    types: [opened, edited, deleted, closed, reopened, assigned, unassigned, labeled, unlabeled]
  
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read      # ‚úÖ Checkout repository
  pages: write        # ‚úÖ Deploy to GitHub Pages
  id-token: write     # ‚úÖ OIDC token for secure deployment validation
  issues: read        # ‚úÖ Fetch issues via GitHub API

# Allow only one concurrent deployment, cancel in-progress runs in favor of latest
concurrency:
  group: "pages-deployment"
  cancel-in-progress: true

jobs:
  # Fetch issues and deploy
  fetch-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create data directory
        run: mkdir -p docs/data
      
      - name: Fetch all issues from GitHub API
        id: fetch-issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching issues from ${{ github.repository }}..."

          # Extract 'since' date from config.toml
          SINCE_DATE=$(grep -A 3 '\[issues-api\]' docs/config.toml | grep 'since' | sed 's/.*"\(.*\)".*/\1/')
          if [ -z "$SINCE_DATE" ]; then
            echo "‚ùå 'since' date not found in config.toml. Please ensure it is set under [issues-api]."
            exit 1
          fi
          echo "üìÖ Using since date: $SINCE_DATE"

          PAGE=1
          OUTPUT_FILE="docs/data/issues.json"
          TEMP_FILE="temp_issues.json"

          # Initialize empty array
          echo "[]" > "$OUTPUT_FILE"

          # Fetch all issues (no label filtering)
          echo "üì• Fetching all issues..."
          while true; do
            echo "üìÑ Processing page $PAGE..."
            
            if ! RESPONSE=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/issues?state=all&per_page=100&page=$PAGE&sort=updated&direction=desc&since=$SINCE_DATE" 2>/dev/null); then
              echo "‚ùå Failed to fetch page $PAGE"
              break
            fi
            
            if [ -z "$RESPONSE" ] || [ "$RESPONSE" = '[]' ]; then
              echo "‚úÖ No more issues to fetch."
              break
            fi
            
            # Merge with existing data
            jq -s '.[0] + .[1]' "$OUTPUT_FILE" <(echo "$RESPONSE") > "$TEMP_FILE"
            mv "$TEMP_FILE" "$OUTPUT_FILE"

            COUNT=$(echo "$RESPONSE" | jq length)
            if [ $COUNT -lt 100 ]; then
              echo "‚úÖ Reached final page."
              break
            fi
            
            ((PAGE++))
            sleep 1  # Be nice to the API
          done

          # Show summary
          TOTAL_ISSUES=$(jq length "$OUTPUT_FILE")
          OPEN_ISSUES=$(jq '[.[] | select(.state == "open")] | length' "$OUTPUT_FILE")
          CLOSED_ISSUES=$(jq '[.[] | select(.state == "closed")] | length' "$OUTPUT_FILE")
          PROJECT_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "project")] | length' "$OUTPUT_FILE")
          ENHANCEMENT_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "enhancement")] | length' "$OUTPUT_FILE")
          BLOCKED_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "blocked")] | length' "$OUTPUT_FILE")
          WIN_ISSUES=$(jq '[.[] | select(.labels[]? | .name == "win")] | length' "$OUTPUT_FILE")
          
          echo "üéâ Successfully saved $TOTAL_ISSUES issues to $OUTPUT_FILE"
          echo "üìä Open: $OPEN_ISSUES | Closed: $CLOSED_ISSUES"
          echo "üè∑Ô∏è  Project: $PROJECT_ISSUES | Enhancement: $ENHANCEMENT_ISSUES"
          echo "üö´ Blocked: $BLOCKED_ISSUES | üèÜ Wins: $WIN_ISSUES"
          echo "üìÖ Filtered since: $SINCE_DATE"
          
          # Set outputs for summary
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "open_issues=$OPEN_ISSUES" >> $GITHUB_OUTPUT
          echo "closed_issues=$CLOSED_ISSUES" >> $GITHUB_OUTPUT
          echo "project_issues=$PROJECT_ISSUES" >> $GITHUB_OUTPUT
          echo "enhancement_issues=$ENHANCEMENT_ISSUES" >> $GITHUB_OUTPUT
          echo "blocked_issues=$BLOCKED_ISSUES" >> $GITHUB_OUTPUT
          echo "win_issues=$WIN_ISSUES" >> $GITHUB_OUTPUT
          echo "since_date=$SINCE_DATE" >> $GITHUB_OUTPUT
      
      - name: Generate Workflow Summary
        run: |
          echo "## üìä Dashboard Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues Fetched" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Issues:** ${{ steps.fetch-issues.outputs.total_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Open Issues:** ${{ steps.fetch-issues.outputs.open_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Closed Issues:** ${{ steps.fetch-issues.outputs.closed_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Work Type Breakdown" >> $GITHUB_STEP_SUMMARY
          echo "- **üìê Project Issues:** ${{ steps.fetch-issues.outputs.project_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üí° Enhancement Issues:** ${{ steps.fetch-issues.outputs.enhancement_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üö´ Blocked Issues:** ${{ steps.fetch-issues.outputs.blocked_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "- **üèÜ Win Issues:** ${{ steps.fetch-issues.outputs.win_issues }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Filtering" >> $GITHUB_STEP_SUMMARY
          echo "- **Since Date:** ${{ steps.fetch-issues.outputs.since_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Note:** Dashboard categorizes issues without 'project' or 'enhancement' labels as 'other'" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Dashboard successfully deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** \`${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload docs directory (includes data folder with issues.json)
          path: './docs'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
